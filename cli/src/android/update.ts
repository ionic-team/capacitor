import { Config } from '../config';
import { log, runTask } from '../common';
import { Plugin, PluginType, getPlugins } from '../plugin';
import { getAndroidPlugins } from './common';
import { copyCordovaJS, copyPluginsJS, createEmptyCordovaJS, getPluginPlatform, getPluginType, removePluginFiles } from '../tasks/update';
import { copySync, ensureDirSync, removeSync, writeFileAsync } from '../util/fs';
import { allSerial } from '../util/promise';
import { join, resolve } from 'path';

const platform = 'android';

export async function updateAndroid(config: Config, needsUpdate: boolean) {
  const plugins = await runTask('Fetching plugins', async () => {
    const allPlugins = await getPlugins();
    const androidPlugins = await getAndroidPlugins(allPlugins);
    return androidPlugins;
  });

  const capacitorPlugins = plugins.filter(p => getPluginType(p, platform) === PluginType.Code);
  const cordovaPlugins = plugins .filter(p => getPluginType(p, platform) === PluginType.Cordova);

  if (cordovaPlugins.length > 0) {
    log(`Found ${cordovaPlugins.length} Cordova plugin(s):\n${cordovaPlugins.map(p => '  ' + p.name).join('\n')}`);
    await copyCordovaJS(config, platform);
    await copyPluginsJS(config, cordovaPlugins, platform);
    copyPluginsNativeFiles(config, cordovaPlugins);
  } else {    
    removePluginFiles(config, platform);
    createEmptyCordovaJS(config, platform);
  }
  await autoGenerateConfig(config, cordovaPlugins);

  await installGradlePlugins(config, capacitorPlugins);
}

export async function autoGenerateConfig(config: Config, cordovaPlugins: Plugin[]) {
  const xmlDir = join(config.android.resDir, 'xml');
  ensureDirSync(xmlDir);
  const cordovaConfigXMLFile = join(xmlDir, 'config.xml');
  removeSync(cordovaConfigXMLFile);
  let pluginEntries: Array<any> = [];
  cordovaPlugins.map( p => {
    const androidPlatform = getPluginPlatform(p, platform);
    if (androidPlatform) {
      const androidConfigFiles = androidPlatform['config-file'];
      if (androidConfigFiles) {
        const configXMLEntries = androidConfigFiles.filter(function(item: any) { return item.$.target === 'res/xml/config.xml'; });
        configXMLEntries.map(  (entry: any)  => {
          const feature = { feature: entry.feature };
          pluginEntries.push(feature);
        });
      }
    }
  });

  const pluginEntriesString: Array<string> = await Promise.all(pluginEntries.map(async (item): Promise<string> => {
    const xmlString = await writeXML(item);
    return xmlString;
  }));
  const content = `<?xml version='1.0' encoding='utf-8'?>
  <widget version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
  ${pluginEntriesString.join('\n')}
  </widget>`;
  writeFileAsync(cordovaConfigXMLFile, content);
}

export async function installGradlePlugins(config: Config, plugins: Plugin[]) {
  log(`Found ${plugins.length} Capacitor plugin(s):\n${plugins.map(p => '  ' + p.name).join('\n')}`);

  const settingsLines = `// DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME "capacitor update" IS RUN
${plugins.map(p => {
    return `
include ':${p.id}'
project(':${p.id}').projectDir = new File('../node_modules/${p.id}/android/${p.id}')
    `;
  }).join('')}`;


const dependencyLines = `// DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME "capacitor update" IS RUN

dependencies {
${plugins.map(p => {
    return `    implementation project(':${p.id}')`;
  }).join('\n')}
}`;

  await writeFileAsync(join(config.app.rootDir, 'android/capacitor.settings.gradle'), settingsLines);
  await writeFileAsync(join(config.app.rootDir, 'android/app/capacitor.build.gradle'), dependencyLines)
}

export function writeXML(object: any): Promise<any> {
  return new Promise(async (resolve, reject) => {
    const xml2js = await import('xml2js');
    const builder = new xml2js.Builder({ headless: true, explicitRoot: false, rootName: 'deleteme' });
    let xml = builder.buildObject(object);
    xml = xml.replace('<deleteme>', '').replace('</deleteme>', '');
    resolve(xml);
  });
}

function copyPluginsNativeFiles(config: Config, cordovaPlugins: Plugin[]) {
  const pluginsPath = resolve('node_modules', '@capacitor/cli', 'assets', 'capacitor-android-plugins', 'src', 'main');
  removeSync(join(pluginsPath, 'java'));
  removeSync(join(pluginsPath, 'res'));
  cordovaPlugins.map( p => {
    const androidPlatform = getPluginPlatform(p, platform);
    if (androidPlatform) {
      const sourceFiles = androidPlatform['source-file'];
      if (sourceFiles) {
        sourceFiles.map( (sourceFile: any) => {
          const fileName = sourceFile.$.src.split("/").pop();
          const target = sourceFile.$["target-dir"].replace('src/', 'java/');
          copySync(join(p.rootPath, sourceFile.$.src), join(pluginsPath, target, fileName));
        });
      }
      const resourceFiles = androidPlatform['resource-file'];
      if(resourceFiles) {
        resourceFiles.map( (resourceFile: any) => {
          copySync(join(p.rootPath, resourceFile.$.src), join(pluginsPath, resourceFile.$["target"]));
        });
      }
    }
  });
}
